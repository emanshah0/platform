import React from 'react';
import ReactDOMServer from 'react-dom/server';
import LineGraph from './LineGraph';

const PrintButton = ({ components }) => {
  const printDiv = () => {
    const printWindow = window.open('', '_blank');
    const printContents = getPrintContents();
    printWindow.document.write(`
      <html>
        <head>
          <title>Print</title>
        </head>
        <body>
          ${printContents}
          <script type="text/javascript">
            window.onload = function() {
              window.print();
              window.onafterprint = function() {
                window.close();
              };
            };
          </script>
        </body>
      </html>
    `);
    printWindow.document.close();
  };

  const getPrintContents = () => {
    return components.map((component, index) => {
      if (component.type === LineGraph) {
        const chartRef = React.createRef();
        const lineGraphProps = {
          ...component.props,
          chartRef: chartRef,
        };
        return getLineGraphImage(lineGraphProps);
      }
      return ReactDOMServer.renderToStaticMarkup(component);
    }).join('');
  };

  const getLineGraphImage = (props) => {
    const { chartRef, ...otherProps } = props;
    const lineGraph = (
      <div>
        <LineGraph {...otherProps} chartRef={chartRef} />
        <img src={getChartImage(chartRef)} alt="Line Graph" />
      </div>
    );
    return ReactDOMServer.renderToStaticMarkup(lineGraph);
  };

  const getChartImage = (chartRef) => {
    const canvas = chartRef.current.chartInstance.canvas;
    return canvas.toDataURL();
  };

  return (
    <div>
      <button onClick={printDiv}>Print Page</button>
    </div>
  );
};

export default PrintButton;
